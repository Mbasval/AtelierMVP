<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>MVP: Listado + Mapa con Leaflet (OSM)</title>

  <!-- 1) Estilos b√°sicos -->
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    #map {
      width: 100%;
      height: 400px;
      margin-bottom: 2rem;
    }
    #lista-proveedores {
      max-width: 600px;
      margin: 0 auto;
      border-collapse: collapse;
      width: 100%;
    }
    #lista-proveedores th,
    #lista-proveedores td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    #lista-proveedores th {
      background: #f7f7f7;
    }
    #lista-proveedores tr:nth-child(even) {
      background: #f9f9f9;
    }
  </style>

  <!-- 2) Carga Leaflet CSS y JS desde CDN -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-o1HMUuF46bXgX+NbQPqQhK9SmXTUynw+QvM4fCF7JQA="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-pxLu1/J+6XBA/z6ROEfCytkXGZJEwFua4ApKx4mdn6E="
    crossorigin=""
  ></script>

  <!-- 3) Carga PapaParse para parsear CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

  <h1>Vendedores ‚Äì MVP con Leaflet (OSM)</h1>

  <!-- 4) Contenedor para el mapa -->
  <div id="map"></div>

  <!-- 5) Tabla de datos -->
  <table id="lista-proveedores">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Servicios</th>
        <th>Tel√©fono</th>
        <th>Direcci√≥n</th>
      </tr>
    </thead>
    <tbody>
      <!-- Aqu√≠ inyectamos las filas -->
    </tbody>
  </table>

  <!-- 6) Script principal -->
  <script>
    // 6.1: Reemplaza con tu URL CSV p√∫blica de Google Sheet
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1g0UNi055ZvOL-_wi7MJUU6RMzzhkEz9ClclHVaZGEky-sf7x7fa7vGUzAScKgy3qhbBXM2bOpMBi/pub?output=csv";

    // 6.2: Inicializa Leaflet
    const map = L.map("map").setView([23.6345, -102.5528], 4);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '¬© <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    }).addTo(map);

    // 6.3: Geocodificar direcci√≥n con Nominatim (OpenStreetMap)
    function geocodeOSM(address, callback) {
      // URL de Nominatim para geocoding
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
        address
      )}`;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            callback(null, [lat, lon]);
          } else {
            callback("No se encontr√≥ ubicaci√≥n", null);
          }
        })
        .catch(err => callback(err, null));
    }

    // 6.4: Cargar y procesar el CSV con PapaParse
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function (results) {
        const data = results.data; // Array de { Nombre, Servicios, "Tel√©fono", Direcci√≥n }
        const tbody = document.querySelector("#lista-proveedores tbody");

        if (!data || data.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML =
            '<td colspan="4" style="text-align:center;">No se encontraron vendedores.</td>';
          tbody.appendChild(tr);
          return;
        }

        // Array para guardar coordenadas y ajustar bounds luego
        let marcadoresCount = 0;
        const ubicaciones = [];

        data.forEach((row, index) => {
          const nombre = row["Nombre"] || "";
          const servicios = row["Servicios"] || "";
          const telefono = row["Tel√©fono"] || "";
          const direccion = row["Direcci√≥n"] || "";

          // 6.4.1: Agregar fila a la tabla
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${nombre}</td>
            <td>${servicios}</td>
            <td>${telefono}</td>
            <td>${direccion}</td>
          `;
          tbody.appendChild(tr);

          // 6.4.2: Geocodificar con Nominatim y crear marcador
          if (direccion.trim().length > 0) {
            geocodeOSM(direccion, (err, latlon) => {
              marcadoresCount++;
              if (!err && latlon) {
                const [lat, lon] = latlon;
                const marker = L.marker([lat, lon]).addTo(map);
                marker.bindPopup(`<strong>${nombre}</strong><br>${direccion}<br>üìû ${telefono}`);
                ubicaciones.push([lat, lon]);
              } else {
                console.warn(`No se pudo geocodificar ‚Äú${direccion}‚Äù:`, err);
              }
              // Una vez que intentamos geocodificar todas las filas, ajustamos bounds
              if (marcadoresCount === data.length) {
                if (ubicaciones.length > 0) {
                  const bounds = L.latLngBounds(ubicaciones);
                  map.fitBounds(bounds.pad(0.2));
                }
              }
            });
          } else {
            // Si no hay direcci√≥n, contamos como ‚Äúprocesado‚Äù para el ajuste de bounds
            marcadoresCount++;
            if (marcadoresCount === data.length && ubicaciones.length > 0) {
              const bounds = L.latLngBounds(ubicaciones);
              map.fitBounds(bounds.pad(0.2));
            }
          }
        });
      },
      error: function (err) {
        console.error("Error al cargar CSV:", err);
        const tbody = document.querySelector("#lista-proveedores tbody");
        const tr = document.createElement("tr");
        tr.innerHTML =
          '<td colspan="4" style="text-align:center;">Error al cargar datos.</td>';
        tbody.appendChild(tr);
      },
    });
  </script>
</body>
</html>
