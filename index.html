<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>MVP: Listado + Mapa de Vendedores</title>

  <!-- 1) Estilos b√°sicos -->
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    #map {
      width: 100%;
      height: 400px;
      margin-bottom: 2rem;
    }
    #lista-proveedores {
      max-width: 600px;
      margin: 0 auto;
      border-collapse: collapse;
      width: 100%;
    }
    #lista-proveedores th,
    #lista-proveedores td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    #lista-proveedores th {
      background: #f7f7f7;
    }
    #lista-proveedores tr:nth-child(even) {
      background: #f9f9f9;
    }
  </style>

  <!-- 2) Cargamos la API de Google Maps (reemplaza TU_API_KEY por tu clave real) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&callback=initMap" async defer></script>

  <!-- 3) Cargamos PapaParse para parsear CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

  <h1>Vendedores ‚Äì MVP</h1>

  <!-- 4) Contenedor para el Mapa -->
  <div id="map"></div>

  <!-- 5) Tabla de datos -->
  <table id="lista-proveedores">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Servicios</th>
        <th>Tel√©fono</th>
        <th>Direcci√≥n</th>
      </tr>
    </thead>
    <tbody>
      <!-- Aqu√≠ inyectaremos filas -->
    </tbody>
  </table>

  <!-- 6) Script principal: carga el CSV, llena tabla y coloca marcadores -->
  <script>
    // 6.1 Reemplaza con tu URL CSV real (de "Publicar en la web")
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1g0UNi055ZvOL-_wi7MJUU6RMzzhkEz9ClclHVaZGEky-sf7x7fa7vGUzAScKgy3qhbBXM2bOpMBi/pub?output=csv";

    // 6.2 Variables globales para usar en initMap
    let map;            // el mapa de Google
    let geocoder;       // el servicio de geocodificaci√≥n

    // 6.3 Funci√≥n que inicializa el mapa (se invoca cuando carga la API de Google Maps)
    function initMap() {
      // Centrar el mapa en coordenadas generales (M√©xico / EE. UU.)
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 23.6345, lng: -102.5528 },
        zoom: 4
      });
      geocoder = new google.maps.Geocoder();

      // Despu√©s de inicializar el mapa, cargamos el CSV
      cargarCSV();
    }

    // 6.4 Funci√≥n para cargar y procesar el CSV con PapaParse
    function cargarCSV() {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data; // Array de objetos { Nombre: "...", Servicios: "...", "Tel√©fono": "...", Direcci√≥n: "..." }
          const tbody = document.querySelector("#lista-proveedores tbody");

          if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="4" style="text-align:center;">No se encontraron vendedores.</td>';
            tbody.appendChild(tr);
            return;
          }

          // Array para guardar todas las direcciones y luego ajustar el zoom/bounds
          const addressesParaBounds = [];

          // Iterar cada fila
          data.forEach(row => {
            const nombre = row["Nombre"] || "";
            const servicios = row["Servicios"] || "";
            const telefono = row["Tel√©fono"] || "";
            const direccion = row["Direcci√≥n"] || "";

            // --- 6.4.1: Agregar fila a la tabla HTML ---
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${nombre}</td>
              <td>${servicios}</td>
              <td>${telefono}</td>
              <td>${direccion}</td>
            `;
            tbody.appendChild(tr);

            // --- 6.4.2: Geocodificar direcci√≥n y colocar marcador ---
            if (direccion.trim().length > 0) {
              geocoder.geocode({ address: direccion }, function(resultsGeo, status) {
                if (status === "OK" && resultsGeo[0]) {
                  const location = resultsGeo[0].geometry.location;
                  // Crear marcador
                  const marker = new google.maps.Marker({
                    map: map,
                    position: location,
                    title: nombre
                  });
                  // Popup (tooltip) al hacer clic
                  const infoWindow = new google.maps.InfoWindow({
                    content: `<strong>${nombre}</strong><br>${direccion}<br>üìû ${telefono}`
                  });
                  marker.addListener("click", function() {
                    infoWindow.open(map, marker);
                  });
                  // Guardamos latLng para ajustar bounds luego
                  addressesParaBounds.push(location);
                  // Una vez todos los geocodings se hayan procesado (aprox.), ajustamos la vista
                  if (addressesParaBounds.length === data.length) {
                    ajustarBounds(addressesParaBounds);
                  }
                } else {
                  console.warn("Geocoding fall√≥ para:", direccion, "Status:", status);
                }
              });
            }
          });
        },
        error: function(err) {
          console.error("Error al cargar CSV:", err);
          const tbody = document.querySelector("#lista-proveedores tbody");
          const tr = document.createElement("tr");
          tr.innerHTML = '<td colspan="4" style="text-align:center;">Error al cargar datos.</td>';
          tbody.appendChild(tr);
        }
      });
    }

    // 6.5 Ajustar los l√≠mites del mapa seg√∫n los marcadores
    function ajustarBounds(locationsArray) {
      if (!locationsArray || locationsArray.length === 0) return;
      const bounds = new google.maps.LatLngBounds();
      locationsArray.forEach(loc => bounds.extend(loc));
      map.fitBounds(bounds);
    }
  </script>
</body>
</html>
